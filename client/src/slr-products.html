<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="./slr-fab.html">
<link rel="import" href="./slr-items-data.html">
<link rel="import" href="./slr-card.html">
<link rel="import" href="./slr-product-view.html">

<dom-module id="slr-products">
  <template>
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
        text-align: left;
      }
    </style>

    <slr-items-data
      id="productsData"
      slug="{{selectedSlug}}"
      item="{{selectedProduct}}"
      items="{{products}}"
      filtered-items="{{filteredProducts}}"
      search="[[searchStr]]"
      url="/api/products"
      item-type="Product"
      loading="{{loading}}"></slr-items-data>

    <slr-product-view
      id="view"
      item="{{selectedProduct}}"
      slug="{{selectedSlug}}"
      products="{{products}}"
      product-groups="{{productGroups}}"
      opened="{{viewIsOpen}}"
      loading="{{loading}}"
      route="{{route}}"
      visible="{{visible}}"></slr-product-view>

    <iron-list
      grid
      items="[[filteredProducts]]"
      scroll-target="document">
      <template>
        <a href="/products/[[item.slug]]">
          <slr-card
            hidden$="[[!item.name]]"
            title="[[item.name]]"
            description="[[item.product_group_name]]"></slr-card>
        </a>
      </template>
    </iron-list>

    <slr-fab
      id="fab"
      visible
      on-click="addProduct"></slr-fab>

  </template>

  <script>
    class SlrProducts extends Polymer.Element {
      static get is() { return 'slr-products' }

      static get properties() {
        return {
          products: {
            type: Array,
            value: []
          },
          productGroups: {
            type: Array
          },
          route: {
            type: Object
          },
          visible: {
            type: Boolean,
            value: false
          },
          loading: {
            type: Boolean,
            value: true,
            notify: true
          },
          viewIsOpen: {
            type: Boolean
          },
          searchStr: {
            type: String
          },
          filteredProducts: {
            type: Array
          },
          selectedProduct: {
            type: Object
          },
          selectedSlug: {
            type: String
          }
        }
      }

      static get observers() { return [
        'routeChanged(route, visible)',
      ]}

      routeChanged(route, visible) {
        if (visible) {
          this.$.productsData.fetch()
        }
      }

      ready() {
        super.ready()

        this.addEventListener('slr-product-view-submitted', (e) => {
          this.set('selectedProduct', null)
          if (e.detail.item && e.detail.item.slug) {
            this.set('selectedSlug', e.detail.item.slug)
          } else {
            this.set('selectedSlug', null)
          }
          this.$.productsData.fetch()
        })

        this.addEventListener('slr-product-view-cancelled', (e) => {
          if (!e.detail.item.name) {
            this.pop('products')
          }
        })

        this.addEventListener('slr-dialog-opened', (e) => {
          this.$.fab.hide()
        })

        this.addEventListener('slr-dialog-closed', (e) => {
          this.set('selectedSlug', null)
          this.$.fab.show()
        })
      }

      addProduct() {
        this.$.view.new()
        this.$.fab.hide()
      }

      computeFilter(str) {
        return SlrUtils.filterCollection(str)
      }
    }

    window.customElements.define(SlrProducts.is, SlrProducts)
  </script>
</dom-module>
