<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="./slr-product-group-card.html">
<link rel="import" href="./slr-product-group-view.html">
<link rel="import" href="./slr-utils.html">
<link rel="import" href="./common-styles.html">

<dom-module id="slr-product-groups">
  <template>
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
      }

      .add {
        position: fixed;
        right: 5%;
        bottom: 8%;
      }
    </style>

    <iron-ajax
      id="ajax"
      url="/api/product-groups"
      handle-as="json"
      on-response="handleResponse"
      on-error="handleErrorResponse"
      debounce-duration="300"
      loading={{loading}}></iron-ajax>

    <slr-product-group-view
      id="view"
      item="{{selectedItem}}"
      opened={{viewIsOpen}}
      loading={{loading}}
      product-groups={{productGroups}}
      route={{route}}
      visible={{visible}}></slr-product-group-view>

    <template
      is="dom-repeat"
      items="{{productGroups}}"
      sort="sort"
      observe="favorite"
      filter={{computeFilter(searchStr)}}>
      <a href="/product-groups/{{item.slug}}">
        <slr-product-group-card
          item={{item}}
          favorite={{item.favorite}}></slr-product-group-card>
      </a>
    </template>

    <paper-fab
      class="add"
      icon="add"
      title="add"
      on-click="addProductGroup"
      hidden$={{viewIsOpen}}></paper-fab>

  </template>

  <script>
    class SlrProductGroups extends Polymer.Element {
      static get is() { return 'slr-product-groups' }

      static get properties() {
        return {
          productGroups: {
            type: Array,
            value: [],
            notify: true
          },
          route: {
            type: Object
          },
          visible: {
            type: Boolean
          },
          loading: {
            type: Boolean,
            value: false,
            notify: true
          },
          viewIsOpen: {
            type: Boolean
          },
          searchStr: {
            type: String
          },
          selectedItem: {
            type: Object
          }
        }
      }

      static get observers() { return [
        'routeChanged(route, visible)'
      ]}

      ready() {
        super.ready()
        this.$.view.addEventListener('slr-product-group-submitted', () => {
          this.$.ajax.generateRequest()
        })
      }

      computeFilter(str) {
        return SlrUtils.filterCollection(str)
      }

      routeChanged(route, visible) {
        // always fetch product groups (needed in Products also)
        this.$.ajax.generateRequest()
      }

      handleResponse(e) {
        try {
          this.set('productGroups', e.detail.response.data)
        } catch(e) {
          console.error('Error loading Product Groups')
          this.notify("Can't Load Product Groups", () =>
                                              this.$.ajax.generateRequest())
        }
      }

      handleErrorResponse(e) {
        try {
          if (e.detail.request.xhr.response.status === 401) {
            this.dispatchEvent(
              new CustomEvent('slr-authenticate', {bubbles: true, composed: true})
            )
            return
          }
        } catch(e) {}
        console.error('Error loading Product Groups')
        this.notify("Can't Load Product Groups.", () =>
                                              this.$.ajax.generateRequest(), 0)
      }

      addProductGroup() {
        this.$.view.new()
      }

      sort(a, b) {
        return SlrUtils.favoriteSort(a, b)
      }

      notify(message, action, duration) {
        this.dispatchEvent(
          new CustomEvent('slr-notify', {
            detail: { message, action, duration },
            duration,
            bubbles: true,
            composed: true
          })
        )
      }
    }

    window.customElements.define(SlrProductGroups.is, SlrProductGroups)
  </script>
</dom-module>
