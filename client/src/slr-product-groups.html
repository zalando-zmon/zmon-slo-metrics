<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="./slr-product-group-card.html">
<link rel="import" href="./slr-product-group-view.html">
<link rel="import" href="./slr-utils.html">
<link rel="import" href="./common-styles.html">

<dom-module id="slr-product-groups">
  <template>
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
      }

      .add {
        position: fixed;
        right: 5%;
        bottom: 8%;
      }
    </style>

    <iron-ajax
      id="ajax"
      url="/api/product-groups"
      handle-as="json"
      on-response="handleResponse"
      on-error="handleErrorResponse"
      debounce-duration="300"
      loading={{loading}}></iron-ajax>

    <slr-product-group-view id="view"
                            item="{{selectedItem}}"
                            opened={{viewOpened}}
                            loading={{loading}}
                            edit-mode={{editMode}}
                            route={{route}}></slr-product-group-view>

    <template is="dom-repeat"
              items="{{productGroups}}"
              sort="sort"
              observe="favorite"
              filter={{computeFilter(searchStr)}}>
      <a href="/product-groups/{{item.slug}}">
        <slr-product-group-card item={{item}}
                                favorite={{item.favorite}}
                                on-click="openView"></slr-product-group-card>
      </a>
    </template>

    <paper-fab class="add"
                icon="add"
                title="add"
                on-click="addProductGroup"
                hidden$={{viewOpened}}></paper-fab>

  </template>

  <script>
    class SlrProductGroups extends Polymer.Element {
      static get is() { return 'slr-product-groups' }

      static get properties() {
        return {
          loading: {
            type: Boolean,
            value: true,
            notify: true
          },
          route: {
            type: Object,
            notify: true,
            observer: 'routeChanged'
          },
          productGroups: {
            type: Array,
            value: []
          },
          viewOpened: {
            type: Boolean
          },
          editMode: {
            type: Boolean
          },
          searchStr: {
            type: String
          },
          selectedItem: {
            type: Object
          }
        }
      }

      ready() {
        super.ready()
        this.$.view.addEventListener('slr-product-group-submitted', () => {
          this.$.ajax.generateRequest()
        })
      }

      routeChanged() {
        if (this.route.prefix !== '/product-groups') {
          return
        }

        if (this.route.path) {
          let ix = this.productGroups.findIndex( (pg) => '/'+pg.slug === this.route.path)
          if (ix >= 0) {
            this.openView(this.productGroups[ix])
          }
        }

        this.$.ajax.generateRequest()
      }

      handleResponse(e) {
        try {
          this.set('productGroups', e.detail.response.data)
        } catch(e) {
          console.error('Error loading Product Groups')
          this.dispatchEvent(
            new CustomEvent('slr-notify', {
              detail: {
                message: "Can't Load Product Groups",
                duration: 0,
                action: () => this.$.ajax.generateRequest()
              },
              bubbles: true,
              composed: true
            })
          )
        }
      }

      handleErrorResponse(e) {
        console.error('Error loading Product Groups')
        this.dispatchEvent(
          new CustomEvent('slr-notify', {
            detail: {
              message: "Can't Load Product Groups.",
              duration: 0,
              action: () => this.$.ajax.generateRequest()
            },
            bubbles: true,
            composed: true
          })
        )
      }

      openView(item) {
        this.set('viewOpened', true)
        this.set('selectedItem', item)
      }

      addProductGroup() {
        this.set('selectedItem', {})
        this.set('viewOpened', true)
        this.set('editMode', true)
      }

      sort(a, b) {
        return SlrUtils.favoriteSort(a, b)
      }

      computeFilter(str) {
        return SlrUtils.filterCollection(str)
      }
    }

    window.customElements.define(SlrProductGroups.is, SlrProductGroups)
  </script>
</dom-module>
