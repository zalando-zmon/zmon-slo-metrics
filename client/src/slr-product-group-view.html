<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="./slr-dialog.html">

<dom-module id="slr-product-group-view">
  <template>
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
        text-align: left;
      }

      paper-dialog {
        max-width: var(--app-content-max-width);
        min-width: 500px;
      }
    </style>

    <paper-dialog id="deleteModal"
                  opened={{deleteModalOpened}}>
                  <h2>Delete Product Group</h2>
                  <p>Are you sure you want to delete "{{item.name}}"?</p>
                  <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button dialog-confirm on-click="deleteConfirm">Delete</paper-button>
                  </div></paper-dialog>

    <slr-dialog id="dialog"
                title="Product Group"
                item={{item}}
                icon="close"
                close-url="/product-groups"
                opened={{opened}}
                edit-mode={{editMode}}
                loading={{loading}}
                route={{route}}>
      <div slot="toolbar" hidden="{{!editMode}}">
        <paper-icon-button icon="delete" hidden$="{{!item.uri}}" on-click="delete"></paper-icon-button>
      </div>
      <div slot="actions" hidden$="{{!editMode}}">
        <paper-button id="action"
                      hidden$="{{loading}}"
                      on-click="submit"
                      autofocus>Save</paper-button>
      </div>

      <iron-form id="form" headers={{headers}}>
        <form class="form" method="{{method}}" action="{{action}}">
          <paper-input  name="name"
                        type="text"
                        label="Name"
                        always-float-label
                        disabled={{!editMode}}
                        value="{{item.name}}"
                        required></paper-input>
          <paper-input  name="department"
                        type="text"
                        label="Department" always-float-label
                        disabled={{!editMode}}
                        value="{{item.department}}"
                        required></paper-input>
        </form>
      </iron-form>
    </slr-dialog>
  </template>
  <script>
    class SlrProductGroupView extends Polymer.Element {
      static get is() { return 'slr-product-group-view' }

      static get properties() {
        return {
          item: {
            type: Object
          },
          route: {
            type: Object,
            notify: true
          },
          opened: {
            type: Boolean,
            value: false,
            notify: true
          },
          loading: {
            type: Boolean,
            notify: true
          },
          editMode: {
            type: Boolean,
            value: false,
            notify: true
          },
          headers: {
            type: Object,
            value: {
              'content-type': 'application/json'
            }
          },
          method: {
            type: String,
            value: 'POST'
          },
          action: {
            type: String,
            value: '/api/product-groups',
            computed: 'computeAction(item.uri)'
          },
          deleteModalOpened: {
            type: Boolean,
            value: false
          }
        }
      }

      ready() {
        super.ready()

        this.$.form
          .addEventListener('iron-form-presubmit', () => {
            this.set('loading', true)

            // change method to PUT if we are updating a product Group
            // we need the payload in the body, so we trick iron-form
            // by using POST and changing to PUT right before submit (here)
            if (this.item.uri && this.$.form.request.method === 'POST') {
              this.$.form.request.method = 'PUT'
            }
            console.log('Form submitted:', this.$.form.serializeForm())
          })

        this.$.form
          .addEventListener('iron-form-error', (e) => {
            this.set('loading', false)
            console.error('Error saving Product Group')
            let method = this.$.form.request.method || 'default'
            let m = {
              'POST': 'add',
              'PUT': 'update',
              'DELETE': 'delete',
              'default': 'save'
            }
            this.dispatchEvent(
              new CustomEvent('slr-notify', {
                detail: {
                  message: `Can't ${m[method]} Product Group.`,
                  action: () => this.$.form.submit()
                },
                bubbles: true,
                composed: true
              })
            )
            this.initForm()
          })

        this.$.form
          .addEventListener('iron-form-response', (e) => {
            this.dispatchEvent(new CustomEvent('slr-product-group-submitted'))

            let method = this.$.form.request.method || 'default'
            let m = {
              'POST': 'added',
              'PUT': 'updated',
              'DELETE': 'deleted',
              'default': 'saved'
            }
            let message = `Product Group ${m[method]}.`

            this.dispatchEvent(new CustomEvent('slr-notify',
              {
                detail: { message: message },
                bubbles: true,
                composed: true
              })
            )
            this.initForm()

            if (method === 'DELETE') {
              this.set('opened', false)
              this.set('route.path', '')
            } else {
              this.set('editMode', false)
            }
          })
      }

      computeAction(uri) {
        let a = uri ? uri : '/api/product-groups'
        return a
      }

      initForm() {
        this.set('method', 'POST')
        this.set('action', '/api/product-groups')
      }

      submit() {
        if (!this.$.form.validate()) {
          return
        }
        this.$.form.submit()
      }

      delete() {
        this.set('deleteModalOpened', true)
      }

      deleteConfirm() {
        this.set('method', 'DELETE')
        this.$.form.submit()
      }
    }

    window.customElements.define(SlrProductGroupView.is, SlrProductGroupView)
  </script>
</dom-module>
