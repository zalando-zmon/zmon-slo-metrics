<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="./slr-dialog.html">
<link rel="import" href="./slr-target.html">

<dom-module id="slr-objective-view">
  <template>
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
        text-align: left;
      }

      paper-dialog {
        max-width: var(--app-content-max-width);
        min-width: 500px;
        max-height: 80%;
      }

      iron-label {
        font-family: var(--paper-font-caption_-_font-family);
        -webkit-font-smoothing: var(--paper-font-caption_-_webkit-font-smoothing);
        white-space: var(--paper-font-caption_-_white-space);
        overflow: var(--paper-font-caption_-_overflow);
        text-overflow: var(--paper-font-caption_-_overflow);
        font-size: var(--paper-font-caption_-_font-size);
        font-weight: var(--paper-font-caption_-_font-weight);
        letter-spacing: var(--paper-font-caption_-_letter-spacing);
        line-height: var(--paper-font-caption_-_line-height);
        color: var(--paper-input-container-color, var(--secondary-text-color));
        opacity: 0.66;
        position: relative;
        top: 8px;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/slo/:objectiveId"
      data="{{routeData}}"></app-route>

    <iron-ajax
      id="ajax"
      url="{{item.uri}}"
      handle-as="json"
      on-response="handleResponse"
      on-error="handleErrorResponse"
      debounce-duration="300"
      loading={{loading}}></iron-ajax>

    <paper-dialog
      id="deleteModal"
      opened={{deleteModalOpened}}>
      <h2>Delete Objective</h2>
      <p>Are you sure you want to delete "{{item.title}}"?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-click="deleteConfirm">Delete</paper-button>
      </div></paper-dialog>

    <slr-dialog id="objectiveModal"
                    title="Objective"
                    item={{item}}
                    opened={{opened}}
                    edit-mode={{editMode}}
                    loading={{loading}}>
      <div slot="close">
        <paper-icon-button
          icon="arrow-back"
          title="back"
          on-click="close"></paper-icon-button>
      </div>
      <div slot="toolbar" hidden="{{!editMode}}">
        <paper-icon-button
          icon="delete"
          hidden$="{{!item.uri}}"
          on-click="delete"></paper-icon-button>
      </div>
      <div slot="actions" hidden$="{{!editMode}}">
        <paper-button id="action"
                      hidden$="{{loading}}"
                      on-click="submit"
                      autofocus>Save</paper-button>
      </div>

      <iron-form id="objectiveForm" headers="{{headers}}">
        <form class="form" method="{{method}}" action="{{action}}">
          <paper-input  type="text"
                        name="title"
                        label="Title" always-float-label
                        autofocus="true"
                        disabled="{{!editMode}}"
                        value="{{item.title}}"
                        required></paper-input>
          <paper-input  type="text"
                        name="description"
                        label="Description" always-float-label
                        disabled="{{!editMode}}"
                        value="{{item.description}}"
                        required></paper-input>
        </form>
      </iron-form>
      <iron-label>Targets</iron-label>
      <paper-button
        raised hidden$="{{!editMode}}"
        on-click="addTarget">Add Target</paper-button>
      <ul>
        <template
          is="dom-repeat"
          items="{{item.targets}}"
          as="target">
          <li>
            <slr-target uri="{{target}}" objective="[[item]]" targets="{{item.targets}}" indicators="[[indicators]]"></slr-target>
          </li>
        </template>
        <li hidden="{{item.targets.length}}"><p class="no-items">No targets...</p></li>
      </ul>
    </slr-dialog>
  </template>
  <script>
    class SlrObjectiveView extends Polymer.Element {
      static get is() { return 'slr-objective-view' }

      static get properties() {
        return {
          product: {
            type: Object
          },
          objectives: {
            type: Array
          },
          indicators: {
            type: Array
          },
          item: {
            type: Object
          },
          opened: {
            type: Boolean
          },
          editMode: {
            type: Boolean,
            value: false
          },
          method: {
            type: String,
            value: 'POST'
          },
          action: {
            type: String,
            computed: 'computedAction(item.uri, product.uri)'
          },
          headers: {
            type: Object,
            value: {
              'content-type': 'application/json'
            }
          },
          loading: {
            type: Boolean,
            value: false,
            notify: true
          },
          route: {
            type: Object
          },
          routeData: {
            type: Object
          },
          visible: {
            type: Boolean
          },
          deleteModalOpened: {
            type: Boolean,
            value: false
          }
        }
      }

      static get observers() {
        return [ 'routeDataChanged(routeData.objectiveId, visible)' ]
      }

      routeDataChanged(objectiveId, visible) {
        if (!visible) {
          return
        }

        if (objectiveId) {
          let ix = this.objectives.findIndex((o) =>
                                              o.id === parseInt(objectiveId))
          if (ix > -1) {
            this.set('item', this.objectives[ix])
            this.set('opened', true)
          } else {
            this.routeData.page = '404'
          }
        } else {
          this.set('opened', false)
        }
      }

      ready() {
        super.ready()

        this.$.objectiveModal
          .addEventListener('slr-dialog-closed', () => {
            this.set('routeData.objectiveId', null)
            this.initForm()
          })

        this.addEventListener('slr-target-removed', () => {
          this.$.ajax.generateRequest()
        })

        this.$.objectiveForm
          .addEventListener('iron-form-presubmit', () => {
            this.set('loading', true)
            // change method to PUT if we are updating.
            // we need the payload in the body, so we trick iron-form
            // by using POST and changing to PUT right before submit (here)
            if (this.item.uri && this.$.objectiveForm.request.method === 'POST') {
              this.$.objectiveForm.request.method = 'PUT'
            }
            console.log('Form submitted:', this.$.objectiveForm.serializeForm())
          })

        this.$.objectiveForm
          .addEventListener('iron-form-error', (e) => {
            this.set('loading', false)
            console.error('Error saving Objective.')
            let method = this.$.objectiveForm.request.method || 'default'
            let m = {
              'POST': 'add',
              'PUT': 'update',
              'DELETE': 'delete',
              'default': 'save'
            }

            this.dispatchEvent(
              new CustomEvent('slr-notify', {
                detail: {
                  message: `Can't ${m[method]} Objective.`,
                  action: () => this.$.objectiveForm.submit()
                },
                bubbles: true,
                composed: true
              })
            )

            this.initForm()
          })

        this.$.objectiveForm
          .addEventListener('iron-form-response', (e) => {
            this.set('loading', false)
            this.dispatchEvent(new CustomEvent('slr-objective-submitted'))

            let method = this.$.objectiveForm.request.method || 'default'
            let m = {
              'POST': 'added',
              'PUT': 'updated',
              'DELETE': 'deleted',
              'default': 'saved'
            }

            this.dispatchEvent(new CustomEvent('slr-notify', {
                detail: { message: `Objective ${m[method]}.` },
                bubbles: true,
                composed: true
              })
            )

            this.initForm()

            if (method === 'DELETE') {
              this.set('opened', false)
              this.set('route.path', '')
            } else {
              this.set('editMode', false)
              this.set('item', e.detail.response)
            }
          })
      }

      computedAction(itemUri, productUri) {
        return itemUri ? itemUri : productUri + '/slo'
      }

      submit() {
        if (!this.$.objectiveForm.validate()) {
          return
        }
        this.$.objectiveForm.submit()
      }

      new() {
        this.set('item', {})
        this.set('opened', true)
        this.set('editMode', true)
      }

      addTarget() {
        this.push('item.targets', '')
      }

      close() {
        this.set('opened', false)
        this.set('routeData.objectiveId', '')
      }

      initForm() {
        this.set('method', 'POST')
        this.set('action', '/api/products')
      }

      delete() {
        this.set('deleteModalOpened', true)
      }

      deleteConfirm() {
        this.set('method', 'DELETE')
        this.$.objectiveForm.submit()
      }

      handleResponse(e) {
        try {
          this.set('item', e.detail.response)
        } catch(e) {
          console.error('Error loading Objective')
          this.notify("Can't Load Objective", () => this.$.ajax.generateRequest())
        }
      }

      handleErrorResponse(e) {
        try {
          if (e.detail.request.xhr.response.status === 401) {
            this.dispatchEvent(
              new CustomEvent('slr-authenticate', {bubbles: true, composed: true})
            )
            return
          }
        } catch(e) {}
        console.error('Error loading Objective')
        this.notify("Can't Load Objective.", () => this.$.ajax.generateRequest())
      }
    }
    window.customElements.define(SlrObjectiveView.is, SlrObjectiveView)
  </script>
</dom-module>
