<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="./common-styles.html">

<dom-module id="slr-dialog">
  <template>
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
        text-align: left;
        --paper-input-container-disabled: {
          opacity: 0.66;
        };
      }

      paper-dialog {
        max-width: var(--app-content-max-width);
        min-width: 500px;
      }

      app-toolbar {
        margin-top: 0;
        padding: 0 10px;
        background-color: var(--app-secondary-color);
      }

      paper-fab {
        margin-top: 60px;
        margin-right: 5%;
      }

      .spinner {
        width: 100px;
        text-align: center;
      }

      paper-spinner-lite.orange {
        --paper-spinner-color: var(--app-accent-color);
      }
    </style>

    <paper-dialog
      id="dialog"
      opened="{{opened}}"
      no-cancel-on-outside-click="{{editMode}}"
      no-cancel-on-esc-key="{{editMode}}">

      <app-toolbar>
        <slot name="close"></slot>
        <div main-title>{{title}}</div>
        <paper-fab
          icon="create"
          title="edit"
          on-click="toggleEditMode"
          hidden$="{{editMode}}"
          mini></paper-fab>
          <div hidden="{{!loading}}">
            <div
              id="spinner"
              class="spinner"
              hidden$="{{!editMode}}">
              <paper-spinner-lite
                class="orange"
                active></paper-spinner-lite>
            </div>
          </div>
          <slot name="toolbar"></slot>
      </app-toolbar>

      <paper-dialog-scrollable>
        <slot></slot>
      </paper-dialog-scrollable>

      <div class="buttons" hidden$="{{loading}}">
        <slot name="actions"></slot>
      </div>
    </paper-dialog>
  </template>
  <script>
    class SlrDialog extends Polymer.Element {
      static get is() { return 'slr-dialog' }

      static get properties() {
        return {
          title: {
            type: String
          },
          icon: {
            type: String,
            value: 'close'
          },
          item: {
            type: Object,
            notify: true,
            observer: 'itemChanged'
          },
          // save copy to reset form since iron-form
          // and paper-input have issues
          _item: {
            type: Object
          },
          opened: {
            type: Boolean,
            value: false,
            observer: 'openedChanged',
            notify: true
          },
          editMode: {
            type: Boolean,
            notify: true
          },
          loading: {
            type: Boolean,
            value: false
          }
        }
      }

      static get observers() {
        return [ 'itemPropsChanged(item.slo, item.sli)' ]
      }

      openedChanged(opened) {
        if (opened) {
          return this.whenOpened()
        }
        this.whenClosed()
      }

      whenOpened() {
        this.copyItem()
        this.reset()
        this.dispatchEvent(new CustomEvent('slr-dialog-opened'))
      }

      whenClosed() {
        this.reset()
        this.set('editMode', false)
        this.dispatchEvent(new CustomEvent('slr-dialog-closed'))
      }

      itemChanged() {
        this.copyItem()
        this.center()
      }

      itemPropsChanged(obj) {
        this.copyItem()
        this.center()
      }

      toggleEditMode() {
        this.set('editMode', !this.editMode)
        this.center()
      }

      reset() {
        this.set('item', Object.assign({}, this._item))
        this.center()
      }

      copyItem() {
        this.set('_item', Object.assign({}, this.item))
      }

      // <paper-dialog> fails to center after its content changed size
      // so we center() every time that may happen
      center() {
        setTimeout(() => { this.$.dialog.center() })
      }
    }

    window.customElements.define(SlrDialog.is, SlrDialog)
  </script>
</dom-module>
