<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="./common-styles.html">

<dom-module id="slr-dialog">
  <template>
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
        text-align: left;
        --paper-input-container-disabled: {
          opacity: 0.66;
        };
      }

      paper-dialog {
        max-width: var(--app-content-max-width);
        min-width: 500px;
      }

      app-toolbar {
        margin-top: 0;
        padding: 0 10px;
        background-color: var(--app-secondary-color);
      }

      paper-fab {
        margin-top: 60px;
        margin-right: 5%;
      }

      .spinner {
        width: 100px;
        text-align: center;
      }

      paper-spinner-lite.orange {
        --paper-spinner-color: var(--app-accent-color);
      }
    </style>

    <paper-dialog id="dialog"
                  opened={{opened}}
                  no-cancel-on-outside-click={{editMode}}
                  no-cancel-on-esc-key={{editMode}}>

      <app-toolbar>
        <a href={{backUrl}}>
          <paper-icon-button icon="{{icon}}" title="{{icon}}" dialog-dismiss></paper-icon-button>
        </a>
        <div main-title>{{title}}</div>
        <paper-fab mini icon="create" title="edit" on-click="toggleEditMode" hidden$="{{editMode}}"></paper-fab>
          <div hidden={{!loading}}>
            <div id="spinner" class="spinner" hidden$={{!editMode}}>
              <paper-spinner-lite class="orange" active></paper-spinner-lite>
            </div>
          </div>
          <slot name="toolbar"></slot>
      </app-toolbar>

      <paper-dialog-scrollable>
        <slot></slot>
      </paper-dialog-scrollable>

      <div class="buttons">
        <div hidden$={{loading}}>
          <paper-button hidden$="{{!editMode}}" on-click="cancel">Cancel</paper-button>
        </div>
        <slot name="actions"></slot>
      </div>
    </paper-dialog>
  </template>
  <script>
    class SlrDialog extends Polymer.Element {
      static get is() { return 'slr-dialog' }

      static get properties() {
        return {
          title: {
            type: String
          },
          icon: {
            type: String,
            value: 'close'
          },
          item: {
            type: Object,
            notify: true,
            observer: 'itemChanged'
          },
          // save copy to avoid iron-form and paper-input issues
          _item: {
            type: Object
          },
          opened: {
            type: Boolean,
            value: false,
            notify: true
          },
          editMode: {
            type: Boolean,
            notify: true
          },
          loading: {
            type: Boolean,
            value: false
          },
          backUrl: {
            type: String
          }
        }
      }

      static get observers() {
        return [ 'itemPropsChanged(item.slo, item.sli)' ]
      }

      ready() {
        super.ready();
        this.addEventListener('iron-overlay-opened', this.whenOpened)
        this.addEventListener('iron-overlay-closed', this.whenClosed)
      }

      whenOpened() {
        this.copyItem()
        this.reset()
        this.dispatchEvent(new CustomEvent('slr-dialog-opened'))
      }

      whenClosed() {
        this.reset()
        this.set('editMode', false)
        this.dispatchEvent(new CustomEvent('slr-dialog-closed'))
      }

      itemChanged() {
        this.copyItem()
        this.center()
      }

      itemPropsChanged(obj) {
        this.copyItem()
        this.center()
      }

      toggleEditMode() {
        this.set('editMode', !this.editMode)
        this.center()
      }

      cancel() {
        this.reset()
        this.set('editMode', false)
      }

      reset() {
        this.set('item', Object.assign({}, this._item))
        this.center()
      }

      // <paper-dialog> doesn't center after its content changed size
      // so center() every time that may happen
      center() {
        setTimeout(() => { this.$.dialog.center() })
      }

      copyItem() {
        this.set('_item', Object.assign({}, this.item))
      }
    }

    window.customElements.define(SlrDialog.is, SlrDialog)
  </script>
</dom-module>
