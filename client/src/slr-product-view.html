<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<link rel="import" href="./slr-dialog.html">

<dom-module id="slr-product-view">
  <template>
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
        text-align: left;
      }

      paper-dialog {
        max-width: var(--app-content-max-width);
        min-width: 500px;
        max-height: 80%;
      }

      iron-label {
        font-family: var(--paper-font-caption_-_font-family);
        -webkit-font-smoothing: var(--paper-font-caption_-_webkit-font-smoothing);
        white-space: var(--paper-font-caption_-_white-space);
        overflow: var(--paper-font-caption_-_overflow);
        text-overflow: var(--paper-font-caption_-_overflow);
        font-size: var(--paper-font-caption_-_font-size);
        font-weight: var(--paper-font-caption_-_font-weight);
        letter-spacing: var(--paper-font-caption_-_letter-spacing);
        line-height: var(--paper-font-caption_-_line-height);
        color: var(--paper-input-container-color, var(--secondary-text-color));
        opacity: 0.66;
        position: relative;
        top: 8px;
      }

      .column {
        display: inline-block;
        min-width: 20vw;
        max-height: 80vh;
        padding: 10px;
        vertical-align: top;
        overflow: hidden;
      }

      iron-list {
        margin-top: 5px;
      }

      .list-item {
        padding: 5px;
        opacity: 0.66
      }

    </style>

    <iron-ajax
      id="ajaxSlo"
      url="{{item.product_slo_uri}}"
      handle-as="json"
      on-response="handleSloResponse"
      on-error="handleSloErrorResponse"
      debounce-duration="300"
      loading={{loading}}></iron-ajax>

    <iron-ajax
      id="ajaxSli"
      url="{{item.product_sli_uri}}"
      handle-as="json"
      on-response="handleSliResponse"
      on-error="handleSliErrorResponse"
      debounce-duration="300"
      loading={{loading}}></iron-ajax>

    <slr-dialog id="dialog"
                    title="Product"
                    item={{item}}
                    opened={{opened}}
                    edit-mode={{editMode}}
                    loading={{loading}}>
      <div slot="actions" hidden$="{{!editMode}}">
        <paper-button id="action"
                      hidden$="{{loading}}"
                      on-click="submit"
                      autofocus>Save</paper-button>
      </div>

      <iron-form id="form">
        <form class="form" method="post" action="/api/products">
          <div class="column">
            <paper-input  type="text"
                          name="name"
                          label="Name" always-float-label
                          autofocus="true"
                          disabled={{!editMode}}
                          value="{{item.name}}"
                          required></paper-input>
            <paper-input  type="text"
                          always-float-label
                          name="product-group"
                          label="Product Group"
                          disabled={{!editMode}}
                          value={{item.product_group_name}}
                          required></paper-input>
          </div>
          <div class="column">
            <div class="objectives" hidden$="{{editMode}}">
              <iron-label>Objectives</iron-label>
              <iron-list  id="list"
                          items=[[slo]]
                          as="objective"
                          selection-enabled>
                <template>
                  <div class="list-item">[[objective.title]]</div>
                </template>
              </iron-list>
            </div>
            <paper-textarea name="slo"
                            type="text"
                            label="Objectives"
                            always-float-label
                            placeholder="[]"
                            disabled="{{!editMode}}"
                            rows="14"
                            max-rows="14"
                            value="{{sloStr}}"
                            class="textarea"
                            hidden$="{{!editMode}}"></paper-textarea>
          </div>
          <div class="column">
            <div class="targets" hidden$="{{editMode}}">
              <iron-label>Indicators</iron-label>
              <iron-list  id="list"
                          items="[[sli]]"
                          as="target"
                          selection-enabled>
                <template>
                  <div class="list-item">
                    [[target.name]] [[target.unit]]
                  </div>
                </template>
              </iron-list>
            </div>
            <paper-textarea name="sli"
                            type="text"
                            label="Indicators"
                            always-float-label
                            placeholder="[]"
                            disabled="{{!editMode}}"
                            rows="14"
                            max-rows="14"
                            value="{{sliStr}}"
                            class="textarea"
                            hidden$="{{!editMode}}"></paper-textarea>
          </div>
        </form>
      </iron-form>
    </slr-dialog>

  </template>
  <script>
    class SlrProductView extends Polymer.Element {
      static get is() { return 'slr-product-view' }

      static get properties() {
        return {
          item: {
            type: Object,
            value: {
              slo: [],
              sli: []
            }
          },
          opened: {
            type: Boolean,
            value: false,
            notify: true
          },
          loading: {
            type: Boolean,
            notify: true
          },
          editMode: {
            type: Boolean,
            value: false,
            notify: true
          },
          slo: {
            type: String
          },
          sli: {
            type: String
          },
          sloStr: {
            type: String
          },
          sliStr: {
            type: String
          }
        }
      }

      static get observers() {
        return [
          'itemChanged(item.*)'
        ]
      }

      ready() {
        super.ready()

        this.$.dialog
          .addEventListener('slr-dialog-opened', () => {
            this.whenOpened()
          })

        this.$.form
          .addEventListener('iron-form-presubmit', () => {
            this.set('loading', true)
            console.log('Form submitted:', this.$.form.serializeForm())
          })

        this.$.form
          .addEventListener('iron-form-error', (e) => {
            this.set('loading', false)
            console.error('Error saving Product.')
            this.dispatchEvent(
              new CustomEvent('slr-notify', {
                detail: {
                  message: "Can't save Product.",
                  action: () => this.$.form.submit()
                },
                bubbles: true,
                composed: true
              })
            )
          })

        this.$.form
          .addEventListener('iron-form-response', (e) => {
            this.set('opened', false)
            this.set('loading', false)
            this.dispatchEvent(new CustomEvent('slr-product-group-added'))
            this.dispatchEvent(new CustomEvent('slr-notify', {
                detail: { message: 'Product added.' },
                bubbles: true,
                composed: true
              })
            )
          })
      }

      itemChanged() {
        this.set('slo', [].concat(this.item.slo))
        this.set('sli', [].concat(this.item.sli))
        this.set('sloStr', JSON.stringify(this.item.slo, null, '  '))
        this.set('sliStr', JSON.stringify(this.item.sli, null, '  '))
      }

      whenOpened() {
        this.$.ajaxSlo.generateRequest()
        this.$.ajaxSli.generateRequest()
      }

      submit() {
        if (!this.$.form.validate()) {
          return
        }
        this.$.form.submit()
      }

      handleSloResponse(e) {
        this.set('item.slo', e.detail.response.data)
      }

      handleSliResponse(e) {
        this.set('item.sli', e.detail.response.data)
      }

      handleSloErrorResponse(e) {
        console.error('Error loading Product Objectives')
        this.dispatchEvent(
          new CustomEvent('slr-notify', {
            detail: {
              message: "Can't load Product Objectives.",
              duration: 5000,
              action: () => this.$.ajaxSlo.generateRequest()
            },
            bubbles: true,
            composed: true
          })
        )
      }

      handleSliErrorResponse(e) {
        console.error('Error loading Product Indicators')
        this.dispatchEvent(
          new CustomEvent('slr-notify', {
            detail: {
              message: "Can't load Product Indicators.",
              duration: 5000,
              action: () => this.$.ajaxSli.generateRequest()
            },
            bubbles: true,
            composed: true
          })
        )
      }
    }

    window.customElements.define(SlrProductView.is, SlrProductView)
  </script>
</dom-module>
