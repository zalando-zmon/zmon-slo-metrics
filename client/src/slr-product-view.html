<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<link rel="import" href="./slr-dialog.html">
<link rel="import" href="./slr-objective-view.html">
<link rel="import" href="./slr-indicator-view.html">

<dom-module id="slr-product-view">
  <template>
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
        text-align: left;
      }

      paper-dialog {
        max-width: var(--app-content-max-width);
        min-width: 500px;
        max-height: 80%;
      }

      iron-label {
        font-family: var(--paper-font-caption_-_font-family);
        -webkit-font-smoothing: var(--paper-font-caption_-_webkit-font-smoothing);
        white-space: var(--paper-font-caption_-_white-space);
        overflow: var(--paper-font-caption_-_overflow);
        text-overflow: var(--paper-font-caption_-_overflow);
        font-size: var(--paper-font-caption_-_font-size);
        font-weight: var(--paper-font-caption_-_font-weight);
        letter-spacing: var(--paper-font-caption_-_letter-spacing);
        line-height: var(--paper-font-caption_-_line-height);
        color: var(--paper-input-container-color, var(--secondary-text-color));
        opacity: 0.66;
        position: relative;
        top: 8px;
      }

      paper-card {
        width: 100%;
        overflow: hidden;
        padding: 5px 10px;
      }

      .column {
        display: inline-block;
        min-width: 20vw;
        max-height: 80vh;
        min-height: 250px;
        padding: 10px;
        vertical-align: top;
        overflow: hidden;
        position: relative;
      }

      .column paper-button {
        position: absolute;
        bottom: 10px;
        right: 15px;
      }

      paper-dropdown-menu {
        width: 100%;
      }

    </style>

    <app-route
      route="{{route}}"
      pattern="/:slug"
      data="{{routeData}}"
      tail="{{subroute}}"></app-route>

    <iron-ajax
      id="ajaxSlo"
      url="{{item.product_slo_uri}}"
      handle-as="json"
      on-response="handleSloResponse"
      on-error="handleSloErrorResponse"
      debounce-duration="300"
      loading="{{loading}}"></iron-ajax>

    <iron-ajax
      id="ajaxSli"
      url="{{item.product_sli_uri}}"
      handle-as="json"
      on-response="handleSliResponse"
      on-error="handleSliErrorResponse"
      debounce-duration="300"
      loading="{{loading}}"></iron-ajax>

    <slr-objective-view
      id="objectiveView"
      item="{{selectedObjective}}"
      product="{{item}}"
      objectives="{{objectives}}"
      indicators="{{indicators}}"
      opened="{{objectiveViewOpened}}"
      loading="{{loading}}"
      route="{{subroute}}"
      route-data="{{routeData}}"
      visible="{{visible}}"
      edit-mode="{{objectiveViewEditMode}}"></slr-objective-view>

    <slr-indicator-view
      id="indicatorView"
      item="{{selectedObjective}}"
      product="{{item}}"
      indicators="{{indicators}}"
      opened="{{indicatorViewOpened}}"
      loading="{{loading}}"
      route="{{subroute}}"
      route-data="{{routeData}}"
      visible="{{visible}}"
      edit-mode="{{indicatorViewEditMode}}"></slr-indicator-view>

    <paper-dialog
      id="deleteModal"
      opened="{{deleteModalOpened}}">
      <h2>Delete Product</h2>
      <p>Are you sure you want to delete "{{item.name}}"?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-click="deleteConfirm">Delete</paper-button>
      </div></paper-dialog>

    <slr-dialog
      id="productModal"
      title="Product"
      item="{{item}}"
      opened="{{opened}}"
      edit-mode="{{editMode}}"
      loading="{{loading}}">
      <div slot="close">
        <paper-icon-button
          icon="close"
          title="close"
          on-click="close"></paper-icon-button>
      </div>
      <div slot="toolbar" hidden="{{!editMode}}">
        <paper-icon-button
          icon="delete"
          hidden$="{{!item.uri}}"
          on-click="delete"></paper-icon-button>
      </div>
      <div slot="actions" hidden$="{{!editMode}}">
        <paper-button id="action"
                      hidden$="{{loading}}"
                      on-click="submit"
                      autofocus>Save</paper-button>
      </div>

      <iron-form id="productForm" headers="{{headers}}">
        <form class="form" method="{{method}}" action="{{action}}">
            <div class="column">
              <paper-input
                type="text"
                name="name"
                label="Name" always-float-label
                autofocus="true"
                disabled="{{!editMode}}"
                value="{{item.name}}"
                required></paper-input>
              <paper-dropdown-menu
                label="Product Group"
                always-float-label
                disabled="{{!editMode}}"
                required noink no-animations>
                <paper-listbox
                  id="selectList"
                  slot="dropdown-content"
                  selected="{{item.product_group_uri}}"
                  attr-for-selected="uri">
                  <template
                    is="dom-repeat"
                    items="{{productGroups}}"
                    as="pg">
                    <paper-item uri="{{pg.uri}}">{{pg.name}}</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <input
                type="text"
                name="product_group_uri"
                hidden
                value="[[item.product_group_uri]]"></input>
            </div>
            <div class="column" hidden$="{{!item.uri}}">
              <iron-label>Objectives</iron-label>
              <paper-button
                hidden$="{{!editMode}}"
                on-click="addObjective"
                raised>Add Objective</paper-button>
                <paper-listbox
                  id="objectivesList"
                  slot="dropdown-content">
                  <template
                    is="dom-repeat"
                    items="{{objectives}}"
                    as="objective">
                    <a href="/products/[[item.slug]]/slo/[[objective.id]]">
                      <paper-item>{{objective.title}}</paper-item>
                    </a>
                  </template>
                </paper-listbox>
            </div>
            <div class="column" hidden$="{{!item.uri}}">
              <iron-label>Indicators</iron-label>
              <paper-button
                hidden$="{{!editMode}}"
                on-click="addIndicator"
                raised>Add Indicator</paper-button>
              <paper-listbox
                id="indicatorsList"
                slot="dropdown-content">
                <template
                  is="dom-repeat"
                  items="{{indicators}}"
                  as="indicator">
                  <a href="/products/[[item.slug]]/sli/[[indicator.name]]">
                    <paper-item>{{indicator.name}}</paper-item>
                  </a>
                </template>
              </paper-listbox>
            </div>
          </div>
        </form>
      </iron-form>
    </slr-dialog>

  </template>
  <script>
    class SlrProductView extends Polymer.Element {
      static get is() { return 'slr-product-view' }

      static get properties() {
        return {
          item: {
            type: Object
          },
          products: {
            type: Array
          },
          productGroups: {
            type: Array,
            value: []
          },
          objectives: {
            type: Array,
            value: []
          },
          indicators: {
            type: Array,
            value: []
          },
          route: {
            type: Object
          },
          routeData: {
            type: Object,
            notify: true
          },
          visible: {
            type: Boolean
          },
          opened: {
            type: Boolean,
            value: false,
            notify: true
          },
          loading: {
            type: Boolean,
            notify: true
          },
          editMode: {
            type: Boolean,
            value: false,
            notify: true
          },
          method: {
            type: String,
            value: 'POST'
          },
          action: {
            type: String,
            value: '/api/products',
            computed: 'computeAction(item.uri)'
          },
          headers: {
            type: Object,
            value: {
              'content-type': 'application/json'
            }
          },
          objectiveViewOpened: {
            type: Boolean,
            value: false
          },
          objectiveViewEditMode: {
            type: Boolean,
            value: false
          },
          indicatorViewOpened: {
            type: Boolean,
            value: false
          },
          indicatorViewEditMode: {
            type: Boolean,
            value: false
          },
          selectedObjective: {
            type: Object
          },
          selectedIndicator: {
            type: Object
          },
          deleteModalOpened: {
            type: Boolean,
            value: false
          }
        }
      }

      computeAction(uri) {
        return uri ? uri : '/api/products'
      }

      computeSelectedProductGroup(ix) {
        if (ix > 0) {
          return this.productGroups[ix]
        }
        return null
      }

      computeSelectedProductGroupUri(productGroup) {
        if (productGroup) {
          return productGroup.uri
        }
        return ''
      }

      computeSelectedProductGroupIndex(item, productGroups) {
        if (item && productGroups) {
          return productGroups.findIndex( (pg) => item.product_group_uri === pg.uri )
        }
        return -1
      }

      static get observers() {
        return [ 'routeDataChanged(routeData.slug, visible)' ]
      }

      routeDataChanged(slug, visible) {
        if (!visible) {
          return
        }

        // TODO Fix when Product arr is empty
        if (slug) {
          // // make sure we got the collection before we display an item
          // let ajax = this.$.ajax.generateRequest();
          // Promise.all([ajax.completes]).then((reqs) => {
          //
          let ix = this.products.findIndex((p) => p.slug === slug)
          if (ix > -1) {
            this.set('item', this.products[ix])
            this.set('opened', true)
          } else {
            // TODO Fix 404
            this.routeData.page = '404'
          }
        } else {
          this.set('opened', false)
        }
      }

      ready() {
        super.ready()

        this.$.productModal
          .addEventListener('slr-dialog-opened', () => { this.whenOpened() })

        this.$.productModal
          .addEventListener('slr-dialog-closed', () => {
            this.set('routeData.slug', null)
            this.initForm()
          })

        this.$.productForm
          .addEventListener('iron-form-presubmit', () => {
            this.set('loading', true)
            // change method to PUT if we are updating.
            // we need the payload in the body, so we trick iron-form
            // by using POST and changing to PUT right before submit (here)
            if (this.item.uri && this.$.productForm.request.method === 'POST') {
              this.$.productForm.request.method = 'PUT'
            }
            console.log('Form submitted:', this.$.productForm.serializeForm())
          })

        this.$.productForm
          .addEventListener('iron-form-error', (e) => {

            this.set('loading', false)
            console.error('Error saving Product.')
            let method = this.$.productForm.request.method || 'default'
            let m = {
              'POST': 'add',
              'PUT': 'update',
              'DELETE': 'delete',
              'default': 'save'
            }
            this.notify(`Can't ${m[method]} Product.`, () =>
                                                        this.$.productForm.submit())
            this.initForm()
          })

        this.$.productForm
          .addEventListener('iron-form-response', (e) => {
            this.set('loading', false)
            this.dispatchEvent(new CustomEvent('slr-product-submitted'))

            let method = this.$.productForm.request.method
            let m = {
              'POST': 'Added',
              'PUT': 'Updated',
              'DELETE': 'Deleted'
            }

            this.notify(`${m[method]} Product.`)
            this.initForm()

            if (method === 'DELETE') {
              this.set('opened', false)
              this.set('routeData.slug', null)
            } else {
              this.set('editMode', false)
              this.set('routeData.slug', e.detail.response.slug)
              this.set('item', e.detail.response)
            }
          })

        this.$.objectiveView
          .addEventListener('slr-objective-submitted', () =>
                                            this.$.ajaxSlo.generateRequest())

        this.$.indicatorView
          .addEventListener('slr-indicator-submitted', () =>
                                            this.$.ajaxSli.generateRequest())
      }

      whenOpened() {
        if (this.item.uri) {
          this.$.ajaxSlo.generateRequest()
          this.$.ajaxSli.generateRequest()
        }
      }

      initForm() {
        this.set('method', 'POST')
        this.set('action', '/api/products')
        this.$.productForm.reset()
      }

      submit() {
        if (!this.$.productForm.validate()) {
          return
        }
        this.$.productForm.submit()
      }

      handleSloResponse(e) {
        try {
          this.set('objectives', e.detail.response.data)
        } catch(e) {
          console.error('Error loading Product Objectives', e)
          this.dispatchEvent(
            new CustomEvent('slr-notify', {
              detail: {
                message: "Can't Load Product Objectives",
                duration: 5000,
                action: () => this.$.ajaxSlo.generateRequest()
              },
              bubbles: true,
              composed: true
            })
          )
        }
      }

      handleSliResponse(e) {
        try {
          this.set('indicators', e.detail.response.data)
        } catch(e) {
          console.error('Error loading Product Indicators')
          this.dispatchEvent(
            new CustomEvent('slr-notify', {
              detail: {
                message: "Can't Load Product Indicators",
                duration: 5000,
                action: () => this.$.ajaxSli.generateRequest()
              },
              bubbles: true,
              composed: true
            })
          )
        }
      }

      handleSloErrorResponse(e) {
        if (e.detail.request.xhr.response.status === 401) {
          this.dispatchEvent(
            new CustomEvent('slr-authenticate', {bubbles: true, composed: true})
          )
          return
        }
        console.error('Error loading Product Objectives')
        this.notify("Can't load Product Objectives.", () =>
                                        this.$.ajaxSlo.generateRequest(), 5000)
      }

      handleSliErrorResponse(e) {
        if (e.detail.request.xhr.response.status === 401) {
          this.dispatchEvent(
            new CustomEvent('slr-authenticate', {bubbles: true, composed: true})
          )
          return
        }
        console.error('Error loading Product Indicators')
        this.notify("Can't load Product Indicators.", () =>
                                        this.$.ajaxSli.generateRequest(), 5000)
      }

      addObjective() {
        this.$.objectiveView.new()
      }

      addIndicator() {
        this.$.indicatorView.new()
      }

      delete() {
        this.set('deleteModalOpened', true)
      }

      deleteConfirm() {
        this.set('method', 'DELETE')
        this.$.productForm.submit()
      }

      new() {
        this.set('item', {})
        this.set('objectives', [])
        this.set('indicators', [])
        this.set('opened', true)
        this.set('editMode', true)
      }

      close() {
        this.set('opened', false)
        this.set('routeData.slug', '')
      }

      notify(message, action, duration) {
        this.dispatchEvent(
          new CustomEvent('slr-notify', {
            detail: { message, action, duration },
            duration,
            bubbles: true,
            composed: true
          })
        )
      }
    }

    window.customElements.define(SlrProductView.is, SlrProductView)
  </script>
</dom-module>
